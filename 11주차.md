11주차: 로그인/로그아웃 & 세션/보안 정비 가이드 (프로젝트 적용 버전)

> 목표: 세션 기반 로그인 상태 유지, 게시판에 작성자-세션 연동, 수정/삭제 권한 제한, 로그아웃 시 세션/쿠키 정리, Spring Security 기본 보강.

---
## 1. 세션과 쿠키 개념 정리
- **쿠키**: 브라우저에 저장되는 작은 데이터. JSESSIONID 같은 세션 식별자를 담아 서버에 전달.
- **세션**: 서버 메모리(혹은 스토리지)에 유저 상태를 저장. JSESSIONID로 식별.
- **동작 흐름**: 로그인 성공 → 서버가 세션 생성 & JSESSIONID 발급 → 응답 Set-Cookie → 이후 요청마다 JSESSIONID가 함께 전송 → 서버가 세션을 찾아 로그인 상태 확인.

---
## 2. 로그인 구현 (HttpSession 사용)
- 컨트롤러에서 로그인 성공 시 최소 정보만 세션에 저장(예: `memberId`, `email`, `name`).
- **MemberController.java (예시 방향)**  
  ```java
  @PostMapping("/api/login_check")
  public String login(@RequestParam String email,
                      @RequestParam String password,
                      Model model,
                      HttpSession session) {
      try {
          Member member = memberService.loginCheck(email, password);
          session.setAttribute("memberId", member.getId());
          session.setAttribute("email", member.getEmail());
          session.setAttribute("name", member.getName());
          return "redirect:/";
      } catch (IllegalArgumentException e) {
          model.addAttribute("errorMessage", e.getMessage());
          model.addAttribute("email", email);
          return "login";
      }
  }
  ```
- **로그인 실패**: 에러 메시지와 입력 이메일을 모델에 담아 로그인 페이지로 다시 렌더링.

---
## 3. 게시판 접근/권한 체크 (필수)
- **목록/뷰**는 공개 여부를 결정: 공개 유지 가능.  
- **작성/수정/삭제/좋아요**는 로그인 필요: 세션 확인 후 진행.
- **작성자 세팅**: 클라이언트 입력 `user` 무시하고 세션 `email`(또는 `name`)을 `author`로 주입.
- **수정/삭제 권한**: `board.author` == 세션 `email` 일 때만 허용.
- **BoardRestController 예시** (작성):
  ```java
  @PostMapping("/api/boards")
  public ResponseEntity<Board> addBoard(@ModelAttribute AddBoardRequest request, HttpSession session) {
      String email = (String) session.getAttribute("email");
      if (email == null) return ResponseEntity.status(HttpStatus.UNAUTHORIZED).build();
      request.setUser(email); // 세션 이메일로 덮어쓰기
      Board saved = boardService.save(request);
      return ResponseEntity.status(HttpStatus.CREATED).body(saved);
  }
  ```
- **BoardService 수정/삭제 시** 세션 이메일과 `board.getAuthor()` 비교, 불일치 시 `IllegalArgumentException` 또는 403 응답.

---
## 4. 로그아웃 구현 (세션 무효화 + 쿠키 삭제)
- **MemberController.java (예시)**  
  ```java
  @GetMapping("/logout")
  public String logout(HttpSession session, HttpServletResponse response) {
      session.invalidate();
      Cookie cookie = new Cookie("JSESSIONID", null);
      cookie.setPath("/");
      cookie.setMaxAge(0);
      response.addCookie(cookie);
      return "redirect:/";
  }
  ```

---
## 5. 뷰(Thymeleaf) 처리
- 세션 이메일 존재 여부로 버튼 노출 제어.
- **게시글 뷰 템플릿 예시**:
  ```html
  <div th:if="${session.email != null and session.email == board.author}">
      <a th:href="@{|/board_edit/${board.id}|}">수정</a>
      <form th:action="@{|/api/boards/${board.id}|}" method="post">
          <input type="hidden" name="_method" value="delete"/>
          <button type="submit">삭제</button>
      </form>
  </div>
  ```
- 비로그인 상태라면 로그인/회원가입 CTA 노출.

---
## 6. Spring Security 기본 보강
- `SecurityConfig.java` 제안:
  - CSRF **활성** (`.csrf(withDefaults())`) 후 폼에 `_csrf` 포함.
  - 세션 관리:
    ```java
    .sessionManagement(session -> session
        .invalidSessionUrl("/member_login")
        .maximumSessions(1)
        .maxSessionsPreventsLogin(true)
    )
    ```
  - `permitAll` 범위 최소화: 정적 리소스, 공개 페이지만 허용하고 나머지는 인증 요구.
  - 폼 로그인은 커스텀 컨트롤러를 쓰는 경우 `.formLogin().disable()` 유지 가능. 필요 시 커스텀 로그인 페이지 경로 설정.

---
## 7. 세션 설정 (application.properties)
- 세션 타임아웃: `server.servlet.session.timeout=30m` (예시).
- HTTPS 환경이면: `server.servlet.session.cookie.secure=true`.
- 필요 시 SameSite 옵션 추가(스프링 부트 3.3+ 에서 `server.servlet.session.cookie.same-site=strict` 등).

---
## 8. 테스트 체크리스트
- 로그인 성공 시 세션에 `memberId/email/name` 저장 확인.
- 비로그인 상태에서 글 작성/수정/삭제/좋아요 시 401/리다이렉트 동작 확인.
- 글 작성 시 DB `author`가 세션 이메일로 저장되는지 확인(클라이언트 값 무시).
- 다른 유저 세션으로 수정/삭제 시도 시 거부(403 또는 예외).
- 로그아웃 후 JSESSIONID 쿠키 제거, 재요청 시 로그인 필요 상태로 전환.
- CSRF 활성 시 폼 제출/REST 호출에 토큰 포함 여부 확인.

---
## 9. Git 메모(예시 커밋 태그)
- `[Feat] 로그인 세션 최소정보 저장 및 게시판 권한 체크`
- `[Chore] Security 설정 보강 (세션 관리/CSRF)`
- `[Fix] Board 작성자 세션 연동 및 수정/삭제 권한 검증`
