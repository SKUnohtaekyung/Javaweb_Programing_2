# 10주차: Spring Security 기반 회원가입·로그인 구현 단계

> 개발 단계마다 오류나 빌드 실패가 있으면 먼저 해결하고 다음 단계로 넘어갑니다.

## 1) 의존성 추가 (pom.xml)
- 추가: `spring-boot-starter-security`, `spring-boot-starter-validation`
- 확인: `mvn -pl jar dependency:tree`로 충돌 여부 확인 후 다음 단계 진행

## 2) SecurityConfig 작성 (`jar/src/main/java/com/example/jar/config/SecurityConfig.java`)
- Bean: `BCryptPasswordEncoder`
- `SecurityFilterChain` 설정
  - `permitAll()`: `/`, `/about_detailed`, `/board_list`, `/article_list`, `/api/board/**`, `/api/article/**`, `/join_new`, `/api/members`, `/member_login`, `/api/login_check`, `/hello1004`, 정적 리소스(`/css/**`, `/js/**`, `/images/**`)
  - 그 외는 인증 필요
  - CSRF: 학습 단계에서는 `disable()`하거나, 폼에 CSRF 토큰을 넣는 방식 중 하나를 선택해 일관 적용
- 오류 체크: URL 접근 허용/차단이 의도대로인지 확인 후 다음 단계

## 3) Member 엔티티 (`com.example.jar.model.domain.Member`)
```java
@Entity
@Getter
@NoArgsConstructor(access = AccessLevel.PROTECTED)
@AllArgsConstructor
@Builder
@Table(name = "member", uniqueConstraints = @UniqueConstraint(columnNames = "email"))
public class Member {
    @Id @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    @Column(nullable = false) private String name;
    @Column(nullable = false, unique = true) private String email;
    @Column(nullable = false) private String password; // 암호화 저장
    @Column(nullable = false) private Integer age;
    @Column(nullable = false) private String mobile;
    @Column(nullable = false) private String address;
}
```
- 오류 체크: DDL 생성 시 제약 조건 충돌 없는지 확인

## 4) MemberRepository (`com.example.jar.model.repository.MemberRepository`)
```java
public interface MemberRepository extends JpaRepository<Member, Long> {
    Member findByEmail(String email);
}
```
- 오류 체크: 빈 등록/패키지 스캔 문제 없는지 확인

## 5) DTO + Validation (`com.example.jar.member.dto.AddMemberRequest`)
- 검증 규칙:
  - `name`: `@NotBlank`
  - `email`: `@NotBlank @Email`
  - `password`: `@NotBlank @Pattern("^(?=.*[A-Za-z])(?=.*\\d)(?=.*[!@#$%^&*]).{8,}$")`
  - `age`: `@NotNull @Min(19) @Max(90)`
  - `mobile`: `@NotBlank`
  - `address`: `@NotBlank`
- `toEntity()`로 `Member` 변환 메서드 포함
- 오류 체크: DTO 바인딩 시 검증 메시지 출력되는지 확인

## 6) Service (`com.example.jar.member.service.MemberService`)
- `@Service @RequiredArgsConstructor @Transactional`
- `saveMember(dto)`
  - `validateDuplicateMember(email)` → 존재 시 `IllegalStateException`
  - 비밀번호 `passwordEncoder.encode()` 후 저장
- `loginCheck(email, rawPassword)`
  - 이메일 조회 → 없으면 예외
  - `passwordEncoder.matches(raw, encoded)` → 불일치 시 예외, 일치 시 `Member` 반환
- 오류 체크: 중복 가입, 로그인 실패 시 예외 메시지 확인

## 7) Controller (`com.example.jar.controller.MemberController`)
- GET `/join_new` → `join_new.html`
- POST `/api/members`
  - `@Valid` + `BindingResult`로 검증 오류 전달
  - 성공 시 `join_end.html`
- GET `/member_login` → `login.html`
- POST `/api/login_check`
  - `memberService.loginCheck` 호출
  - 성공: 세션에 사용자 정보 저장 후 메인(`/` 등)으로 리다이렉트
  - 실패: 오류 메시지와 함께 `login.html` 재표시
- 선택: `/logout`으로 세션 무효화 후 메인 이동
- 오류 체크: 라우팅, 리다이렉트, 세션 저장 여부 확인

## 8) 뷰 (`src/main/resources/templates`)
- `join_new.html`: 폼 + 필드별 검증 오류 표시
- `join_end.html`: 가입 완료 안내 + 메인 이동 버튼
- `login.html`: 이메일/비밀번호 입력, “로그인 상태 유지” 체크, 실패 메시지 영역
- 메인(`index.html`)·게시판·블로그 화면이 비회원도 접근 가능한지 SecurityConfig와 맞춰 확인

## 9) 예외 처리
- 중복 가입, 로그인 실패 시 사용자 친화적 메시지 제공
- `GlobalExceptionHandler` 활용 또는 컨트롤러에서 `BindingResult`로 처리
- 화이트라벨 에러는 노출되지 않도록 설정

## 10) 단계별 테스트 체크리스트 (오류 우선)
1. 의존성 추가 후 빌드 에러 없는지 확인  
2. SecurityConfig URL 허용/차단 동작 확인(정적 리소스, `/`, 게시판은 열려 있어야 함)  
3. 가입: 비밀번호 암호화 저장, 이메일 중복 시 예외 확인  
4. 로그인: 성공/실패 플로우 및 리다이렉트 URL 확인  
5. CSRF 설정에 맞게 폼 토큰 포함 여부 점검  
6. 예외 처리 시 사용자 메시지 노출 확인 (화이트라벨 방지)
